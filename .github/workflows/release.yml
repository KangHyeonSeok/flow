name: Release Flow Prompts

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Bump VERSION
        id: bump
        run: |
          VERSION=$(tr -d '\n\r ' < VERSION)
          if ! echo "$VERSION" | grep -E '^([0-9]+)\.([0-9]+)\.([0-9]+)$' > /dev/null; then
            echo "VERSION is not SemVer: $VERSION"
            exit 1
          fi
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "$NEW_VERSION" > VERSION
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $NEW_VERSION"

      - name: Commit and tag version
        run: |
          git add VERSION
          git commit -m "chore: bump version to v${{ steps.bump.outputs.version }} [skip release]"
          git tag -a "v${{ steps.bump.outputs.version }}" -m "Release v${{ steps.bump.outputs.version }}"
          git push origin HEAD:main
          git push origin "v${{ steps.bump.outputs.version }}"

      - name: Copy VERSION to .flow
        run: |
          cp VERSION .flow/version.txt

      - name: Build Spec Graph Extension (.vsix)
        run: |
          cd tools/spec-graph-ext
          # package.json 버전 동기화
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '${{ steps.bump.outputs.version }}';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          npm ci
          npm run build
          # LICENSE 복사
          cp ../../LICENSE ./LICENSE 2>/dev/null || true
          npx vsce package --no-dependencies --allow-missing-repository
          # .vsix 파일을 프로젝트 루트로 이동
          mv *.vsix ../../spec-graph-${{ steps.bump.outputs.version }}.vsix

      - name: Create zip archive
        run: |
          mkdir -p temp-release/.github
          mkdir -p temp-e2e
          cp -r .flow temp-release/
          find temp-release/.flow -type f \( -name "*.pdb" -o -name "*.db" \) -delete
          if [ -d .github/agents ]; then
            cp -r .github/agents temp-release/.github/
          fi
          cp flow.ps1 temp-release/
          cd temp-release
          zip -r ../flow-prompts-${{ steps.bump.outputs.version }}.zip .flow/ .github/ flow.ps1
          cd ..
          cp -r tools/e2e-test temp-e2e/e2e-test
          find temp-e2e/e2e-test -type d -name "__pycache__" -prune -exec rm -rf {} +
          find temp-e2e/e2e-test -type f -name "*.pyc" -delete
          cd temp-e2e
          zip -r ../flow-e2e-test-${{ steps.bump.outputs.version }}.zip e2e-test/
          cd ..
          rm -rf temp-release
          rm -rf temp-e2e

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump.outputs.version }}
          name: Flow Prompts v${{ steps.bump.outputs.version }}
          body: |
            ## Flow Prompts v${{ steps.bump.outputs.version }}
            
            ### 설치 방법
            
            **Windows (PowerShell):**
            ```powershell
            irm https://raw.githubusercontent.com/${{ github.repository }}/main/install.ps1 | iex
            ```

            **Windows + E2E 포함 설치:**
            ```powershell
            $script = irm https://raw.githubusercontent.com/${{ github.repository }}/main/install.ps1
            & ([scriptblock]::Create($script)) -WithE2E
            ```
            
            **macOS / Linux:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
            ```

            **macOS / Linux + E2E 포함 설치:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash -s -- --with-e2e
            ```
            
            ### 업데이트 방법
            
            **Windows:**
            ```powershell
            irm https://raw.githubusercontent.com/${{ github.repository }}/main/update.ps1 | iex
            ```

            **Windows + E2E 포함 업데이트:**
            ```powershell
            $script = irm https://raw.githubusercontent.com/${{ github.repository }}/main/update.ps1
            & ([scriptblock]::Create($script)) -WithE2E
            ```
            
            **macOS / Linux:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/update.sh | bash
            ```

            **macOS / Linux + E2E 포함 업데이트:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/update.sh | bash -s -- --with-e2e
            ```

            **설치 후 E2E만 별도 설치(Windows):**
            ```powershell
            .\.flow\scripts\install-e2e.ps1
            ```

            ### Spec Graph VSCode Extension
            
            `spec-graph-${{ steps.bump.outputs.version }}.vsix` 파일을 다운로드 후:
            ```
            code --install-extension spec-graph-${{ steps.bump.outputs.version }}.vsix
            ```
          files: |
            flow-prompts-${{ steps.bump.outputs.version }}.zip
            flow-e2e-test-${{ steps.bump.outputs.version }}.zip
            spec-graph-${{ steps.bump.outputs.version }}.vsix
          draft: false
          prerelease: false
