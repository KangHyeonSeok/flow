name: Release Flow Prompts

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump VERSION
        id: bump
        run: |
          VERSION=$(tr -d '\n\r ' < VERSION)
          if ! echo "$VERSION" | grep -E '^([0-9]+)\.([0-9]+)\.([0-9]+)$' > /dev/null; then
            echo "VERSION is not SemVer: $VERSION"
            exit 1
          fi
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "$NEW_VERSION" > VERSION
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $NEW_VERSION"

      - name: Commit and tag version
        run: |
          git add VERSION
          git commit -m "chore: bump version to v${{ steps.bump.outputs.version }} [skip release]"
          git tag "v${{ steps.bump.outputs.version }}"
          git push origin HEAD:main
          git push origin "v${{ steps.bump.outputs.version }}"

      - name: Copy VERSION to .flow
        run: |
          cp VERSION .flow/version.txt

      - name: Create zip archive
        run: |
          mkdir -p temp-release/prompts
          cp -r .flow temp-release/
          cp -r .claude temp-release/
          cp -r .github/prompts/* temp-release/prompts/
          cd temp-release
          zip -r ../flow-prompts-${{ steps.bump.outputs.version }}.zip .flow/ .claude/ prompts/
          cd ..
          rm -rf temp-release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bump.outputs.version }}
          name: Flow Prompts v${{ steps.bump.outputs.version }}
          body: |
            ## Flow Prompts v${{ steps.bump.outputs.version }}
            
            ### 설치 방법
            
            **Windows (PowerShell):**
            ```powershell
            irm https://raw.githubusercontent.com/${{ github.repository }}/main/install.ps1 | iex
            ```
            
            **macOS / Linux:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
            ```
            
            ### 업데이트 방법
            
            **Windows:**
            ```powershell
            irm https://raw.githubusercontent.com/${{ github.repository }}/main/update.ps1 | iex
            ```
            
            **macOS / Linux:**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/update.sh | bash
            ```
          files: |
            flow-prompts-${{ steps.bump.outputs.version }}.zip
          draft: false
          prerelease: false
